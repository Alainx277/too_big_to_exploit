use tokio_postgres::Client;
use tower_cookies::Cookies;

pub async fn validate_session(db: &Client, cookies: &Cookies) -> Option<i32> {
    let session_cookie = cookies.get("session")?;
    let token = session_cookie.value();
    db.query_opt(
        "SELECT user_id FROM sessions WHERE token = $1 AND valid_until > NOW()",
        &[&token],
    )
    .await
    .unwrap()
    .map(|d| d.get(0))
}

pub async fn delete_session(db: &Client, cookies: &Cookies) {
    let Some(session_cookie) = cookies.get("session") else { return };
    let token = session_cookie.value();
    db.execute("DELETE FROM sessions WHERE token = $1", &[&token])
        .await
        .unwrap();
}
